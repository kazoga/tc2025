# 静的コードレビュー報告書

## 概要
本レポートは、リポジトリに含まれるROS2パッケージ群を静的にレビューした結果をまとめたものである。各指摘事項について、影響度・根本原因・修正提案を記載する。

## 指摘事項

### 1. SKIPロジックでの型崩れによりReportStuck処理が失敗する
- **対象ファイル**: `ros2_src/route_manager/route_manager/manager_core.py`
- **該当箇所**: 508-541行
- **影響度**: 高
- **根本原因**: `_try_skip` 内で `cur_idx` に整数インデックスが渡される想定だが、直後の `cur_idx = self.route_model.waypoints[cur_idx]` で同名変数へ `WaypointLite` を再代入している。そのまま `cur_idx + 1`、`self.route_model.next_index()` への比較などインデックス前提の演算に進むため、ReportStuckサービス起点で `_try_skip` が呼ばれると `TypeError: unsupported operand type(s) for +: 'WaypointLite' and 'int'` が発生し、SKIP手順が失敗して五段階回避フローが中断する。【F:ros2_src/route_manager/route_manager/manager_core.py†L508-L541】
- **修正提案**: インデックスとウェイポイント実体を別変数に分離し、インデックス変数を整数のまま保持する。例として `cur_wp = self.route_model.waypoints[cur_idx]` を導入し、`not_skip` 判定では `cur_wp.not_skip` を参照、以降の演算は元の `cur_idx`（int）を使用する。またログ出力は `cur_idx`（数値）と `cur_wp.label` を併記するなど、型混同を防ぐ。

### 2. FollowerStateのラベル項目を購読できておらず経路進捗の同定精度が低下
- **対象ファイル**: `ros2_src/route_manager/route_manager/route_manager_node.py`
- **該当箇所**: 279-289行
- **影響度**: 中
- **根本原因**: `/follower_state` メッセージのフィールド名は `current_waypoint_label` だが、ノード側では旧名の `current_label` を参照している。そのため常に空文字列が入り、ラベルに基づく進捗補正が効かず、インデックスが一時的にズレた場合に回復できない。【F:ros2_src/route_manager/route_manager/route_manager_node.py†L279-L289】【F:ros2_src/route_msgs/msg/FollowerState.msg†L1-L16】
- **修正提案**: `getattr(msg, "current_waypoint_label", "")` を参照するよう修正し、必要に応じて旧フィールド名との後方互換フォールバックを併記する。

### 3. 障害物停止時のその場旋回が無効化されている
- **対象ファイル**: `ros2_src/robot_simulator/robot_simulator/robot_simulator.py`
- **該当箇所**: 176-208行
- **影響度**: 中
- **根本原因**: 障害物停止ブロック内で計算した `new_yaw` を、その直後の `new_yaw = math.atan2(uy, ux) ...` が常に上書きしてしまうため、停止中に目標方向へ旋回する機構が機能していない。結果としてロボットは障害物を避けた後も姿勢が変わらず、追従再開時に姿勢ずれが残る。【F:ros2_src/robot_simulator/robot_simulator/robot_simulator.py†L176-L208】
- **修正提案**: 障害物停止ブランチで決定した `new_yaw` を保持できるよう、初期値を `new_yaw = yaw` とした上で分岐内部で上書きし、後段で再代入しない（または条件的にのみ上書き）ようにする。

### 4. スタック回避第4段階の再UpdateRouteが成功余地を持たない
- **対象ファイル**: `ros2_src/route_manager/route_manager/manager_core.py`
- **該当箇所**: 385-418行
- **影響度**: 中
- **根本原因**: ReportStuck後の5段階フローで、1段目と4段目のいずれも `_try_update_route` を同条件で呼び出している。途中のSHIFT/SKIPが失敗した場合でもルートモデルやプランナ側引数は変化せず、planner_updateの再実行が成功に転じる契機がない。結果的に第4段階は必ず第1段階と同じ結果（失敗）となり、期待された「ReRoute」分岐が機能しない。【F:ros2_src/route_manager/route_manager/manager_core.py†L385-L418】
- **修正提案**: 第4段階は廃止し、代わりに別条件（例: 回避試行回数や最新障害物状況に基づくプランナ再呼出し条件）を設けるか、planner_updateに与えるインデックス情報を更新して意味のある再試行となるよう設計を見直す。

### 5. 障害物不在スタックでも即座に回避フローへ進む
- **対象ファイル**: `ros2_src/route_manager/route_manager/route_manager_node.py`, `ros2_src/route_manager/route_manager/manager_core.py`
- **該当箇所**: 294-307行, 385-423行
- **影響度**: 高
- **根本原因**: `/report_stuck` で受け取ったリクエストの内容（`reason`・`last_hint_blocked` 等）を全く参照せず、障害物未検知であっても常に5段階の回避処理へ進めている。要求仕様である「障害物を検知せずスタックしている状態では回避行動やエラー遷移はせずに待機する」に反し、不要なSHIFT/SKIPやERROR遷移が発生する恐れがある。【F:ros2_src/route_msgs/srv/ReportStuck.srv†L1-L14】【F:ros2_src/route_manager/route_manager/route_manager_node.py†L294-L307】【F:ros2_src/route_manager/route_manager/manager_core.py†L385-L423】
- **修正提案**: `/report_stuck` リクエスト内容をCoreへ引き渡し、`reason` や `last_hint_blocked` が障害物なしを示す場合はステータスのみ「waiting」に遷移して回避フローを抑止する。FSMへは「保留」イベントを通知するなど、仕様どおり待機状態を維持するロジックを追加する。

## 補足
上記以外にも、以下のような軽微な改善余地が確認された。

- `/active_route` の `start_wp_label` が `route_follower` で `start_label` へ読み替えられており、新フィールドが活用されていない。【F:ros2_src/route_follower/route_follower/route_follower_node.py†L75-L118】【F:ros2_src/route_msgs/msg/Route.msg†L1-L13】
- ルート受信時に `start_index` の境界チェックが無く、異常値でも例外とならずに `FollowerCore.update_route` へ渡される。
- SHIFTロジックについては、`prev_index` と `current_index` を結ぶベクトルに対する単位法線（`unit_normal`）を用い、開放度が大きい側へ `current_index` のWaypointを直交移動させているため、ロボット進行方向に沿った横移動として実装されていることを確認した。【F:ros2_src/route_manager/route_manager/manager_core.py†L463-L486】

いずれも現行挙動に致命的な影響は及ぼさないものの、保守性向上の観点で将来的な修正が望まれる。

