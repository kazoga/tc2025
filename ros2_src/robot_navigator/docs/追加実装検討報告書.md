# robot_navigator 追加実装検討報告書

## 1. 目的
`robot_navigator` ノードでの減速・停止判定を、従来の `/scan` トピックに基づく最小距離計算から、`obstacle_monitor` が配信する `/obstacle_avoidance_hint` の距離情報（`front_clearance_m`）へ切り替え可能にする。既存の `/scan` 入力は後方互換のために残し、運用状況に応じて入力ソースを選択できるようにする。

## 2. 現行実装の整理
### 2.1 障害物距離の取得
`robot_navigator` は初期化時に `/scan` を購読し、コールバック `on_scan()` で LiDAR の各ビームを機体座標へ投影して、前方矩形帯域の最小 `x` 値を `obstacle_distance` として保持する。【F:ros2_src/robot_navigator/robot_navigator/robot_navigator_node.py†L62-L217】

### 2.2 距離の利用箇所
制御ループ `compute_time_optimal_cmd_vel()` は `obstacle_distance` が `None` でなければ停止距離との比較や安全距離内での線形減速を行い、緊急停止時には角速度の抑制まで実施する。計算結果は CSV ログにも書き出される。【F:ros2_src/robot_navigator/robot_navigator/robot_navigator_node.py†L220-L427】

### 2.3 関連トピックとの関係
- `obstacle_monitor` は `/scan` から前方帯域を解析し、閉塞フラグとともに距離ヒント `front_clearance_m` を `ObstacleAvoidanceHint` で publish している。【F:ros2_src/obstacle_monitor/obstacle_monitor/obstacle_monitor_node.py†L192-L217】【F:ros2_src/route_msgs/msg/ObstacleAvoidanceHint.msg†L1-L8】
- `front_clearance_m` は範囲内であれば最近傍距離 [m]、対象範囲外や障害物なしの場合は `float('inf')` が格納される設計で、`route_follower` では最新値を `HintSample` に保持している。【F:ros2_src/obstacle_monitor/obstacle_monitor/obstacle_monitor_node.py†L193-L217】【F:ros2_src/route_follower/route_follower/route_follower_node.py†L151-L160】

## 3. 追加機能の要求整理
1. `/scan` の直接購読による障害物距離計算を維持しつつ、`/obstacle_avoidance_hint` の距離フィールドを利用するモードを追加する。
2. 入力ソースをパラメータなどで切り替え可能にし、既存 launch / YAML との互換性を保つ。
3. ヒント距離が無効値 (`inf`) の場合でも安全側に倒れる挙動を確保する。
4. デバッグログや CSV 出力、進行方向 Marker など既存機能への影響を最小限に留める。

## 4. 設計方針案
### 4.1 入力切替パラメータ
- 新パラメータ `obstacle_distance_mode`（`scan` / `hint` の 2 値）を追加し、既定値を `hint` とする。`ParameterDescriptor` の `additional_constraints` に許容値を明記し、launch や YAML から切り替えられるようにする。【F:ros2_src/robot_navigator/robot_navigator/robot_navigator_node.py†L62-L152】
- ヒント利用時のトピック名を設定する `hint_topic` を追加し、既定値を `obstacle_monitor` が publish する `/obstacle_avoidance_hint` に合わせる。QoS は `obstacle_monitor` 側と同じ BEST_EFFORT / KEEP_LAST(depth=1) を採用し、特別なタイムアウトは設けない。

### 4.2 購読と状態保持
- `obstacle_distance_mode` に応じて購読をセットアップする。
  - `scan` モード: 既存の `LaserScan` 購読のみを有効化し、処理内容は現状維持。
  - `hint` モード: `ObstacleAvoidanceHint` を BEST_EFFORT / KEEP_LAST(depth=1) で購読し、`front_clearance_m` の有限値なら `obstacle_distance` を更新、無効値 (`inf` や `NaN`) の場合は `None` に戻す。
- `self.obstacle_distance` のデータ型や CSV ログの出力仕様は変更せず、ソースの違いによるログ識別が必要であれば別途フィールドを追加する。
- 距離値の正規化は `_apply_obstacle_distance()` のような共通ヘルパーへ集約し、`scan` と `hint` の各コールバックで共有する。これにより、
  減速・停止判定で参照する `self.obstacle_distance` の更新ロジックが二重化せず、一貫した無効値処理を維持できる。

### 4.3 制御ロジックへの組み込み
- `compute_time_optimal_cmd_vel()` は `self.obstacle_distance` のみを参照しているため、距離ソースの切り替えはコールバック層で完結する。ヒント経由で `float('inf')` が届いた場合には `None` と同等に扱い、停止距離比較をスキップする実装とすることで従来挙動と整合がとれる。【F:ros2_src/robot_navigator/robot_navigator/robot_navigator_node.py†L383-L425】
- `HintSample` を利用する将来の `robot_navigator` 内部統計を想定するなら、ヒント受信時に別メンバ（例: `self._latest_hint_raw`）へ保持し、ログや診断メッセージに活用できるようにしておく。

### 4.4 ログ・診断・可視化
- `obstacle_distance_mode` を INFO ログで起動時に通知し、異なるモードでの運用を明示する。
- ゴール状態ログや CSV には現行と同じ `obstacle_distance` を出力する。ソースの識別が必要な場合は CSV ヘッダに `source` 列を追記するか、`dbg` 辞書へ `obstacle_source` を追加する案を検討する。
- 減速・停止判断の可視化として `Marker` を流用できるが、必要に応じて将来的に `/obstacle_avoidance_hint` の距離を Marker メッセージに表示する機能も追加検討余地がある。

### 4.5 設定ファイル・依存関係
- `params/default.yaml` へ新パラメータを追加し、既定値を `hint` としておく。`scan` を利用したい運用では launch で `obstacle_distance_mode:=scan` を明示する。【F:ros2_src/robot_navigator/params/default.yaml†L1-L22】
- `package.xml` に `route_msgs` の依存を追加し、`ObstacleAvoidanceHint` 型を import できるようにする。【F:ros2_src/robot_navigator/package.xml†L1-L19】

## 5. 影響範囲と変更ファイル見込み
- `ros2_src/robot_navigator/robot_navigator/robot_navigator_node.py`
- `ros2_src/robot_navigator/params/default.yaml`
- `ros2_src/robot_navigator/package.xml`
- `ros2_src/robot_navigator/setup.py`
- 必要に応じて launch ファイル（デフォルト引数の注釈追加、引数渡し対応）
- ドキュメント（本書・README 等）

## 6. テスト観点
1. **ユニットレベル**: `python -m compileall` でノードファイルが構文的に正しいことを確認する。
2. **シミュレーションテスト**
   - `scan` モード: 既存のシミュレータ＋ LiDAR で障害物接近時に停止することを確認。
   - `hint` モード: `obstacle_monitor` を併走させ、`front_clearance_m` が `robot_navigator` に反映されて減速/停止が行われることを `ros2 topic echo` と `/cmd_vel` の挙動で検証。
3. **境界条件**: `front_clearance_m=inf` や LaserScan 欠損などで確実に停止指令が出るかをチェック。
4. **設定変更テスト**: Launch / YAML で入力ソースを切り替えてもノードが正常起動し、ログに選択されたモードが表示されること。

## 7. 懸念事項とフォローアップ
- **QoS の差異**: LaserScan は SensorData QoS（BEST_EFFORT/KEEP_LAST）で流れるが、ヒントも同じく BEST_EFFORT/KEEP_LAST(depth=1) の publish であり、通信品質は揃う。追加の QoS 切替パラメータは不要。
- **ヒントの更新遅延**: `obstacle_monitor` 側で距離が `float('inf')` のままになるケース（細い障害物等）があり得るため、`robot_navigator` では保守的に減速/停止を選択する。タイムアウトや時間窓による平滑化は実装しない方針とし、各スキャンの即時値をそのまま扱う。【F:ros2_src/obstacle_monitor/obstacle_monitor/obstacle_monitor_node.py†L193-L209】
- **ログ互換性**: CSV の列数が変わる場合、既存ツールチェーンへの影響を確認する。必要に応じてバージョンヘッダを追加する。
- **launch 運用**: 複数ノードの起動順序によってはヒント受信まで距離が `inf` のままになる時間が発生し得る。ヒントモードでは初期状態を安全側に倒し、ヒント受信前は停止／徐行するようログに注意喚起する。

