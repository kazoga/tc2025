# Waypoint_editor (地図連携エディタ) 詳細設計 v1.2

## 1. 目的と要件の確定

* **目的**

  * `fixed_first.csv` の waypoint 群を **地図（PNG+PGW）上に正確に重ねて表示**し、
    **局所ズーム＋クリックフォーカス**で「位置（0.25 m刻み）」「向き（±5°）」の微調整、**フラグ編集**、**削除**、**CSV 保存（上書き可）**を可能にする。
* **主要要件（再掲）**

  * 背景地図は約 **2000 px**、アスペクト比 **16:9**。
  * 表示は **ナビゲーションモード**（俯瞰覧）と **フォーカスモード**（単点編集）の2系統。
  * フォーカスモードでは、**選択点の周辺を短辺±25 m**に自動ズーム。
  * 編集UI（テキスト・ボタン）は **地図下部に固定配置**。
  * フラグは **5列**：

    * `right_is_open`、`left_is_open`（0以上の整数または小数）
    * `line_is_stop`、`signal_is_stop`、`isnot_skipnum`（0/1 の整数）
  * `label` は **読取専用**。数値は整数表示、文字列は原文表示。
  * 姿勢は ROS 標準どおり **geometry_msgs/Pose** に準拠（四元数の並びは **x,y,z,w**）。
  * **保存名**は `<元名>_edited.csv`。既存があれば**上書き可**。初回保存前に自動バックアップ作成。
  * **近傍選択**のしきい値は既定 **10 px**（設定で変更可能）。

---

## 2. 画面・操作設計

### 2.1 レイアウト

```
+--------------------------------------------------------------------+
| [全体表示] [モード切替(ナビ<->フォーカス)] [保存] [設定]          |
+--------------------------------------------------------------------+
| 地図キャンバス (FigureCanvasTkAgg: 16:9 固定, 等方スケール)       |
|  - 背景: imshow(map.png)                                           |
|  - 全点: scatter + quiver（縮尺自動調整）                           |
|  - 選択: ハイライト + 近傍テキスト（高倍率時）                      |
+--------------------------------------------------------------------+
| 編集パネル (下配置固定)                                            |
|  Label: <RO>    Lat/Lon: <RO>    Pose: x,y,yaw(deg) <RO>           |
|  Flags: right_is_open [entry float≥0]   left_is_open [entry float≥0]|
|         line_is_stop [entry 0/1]  signal_is_stop [entry 0/1]        |
|         isnot_skipnum [entry 0/1]                                   |
|  位置: [↑][↓][←][→][↖][↗][↙][↘]   (各 0.25 m)                      |
|  向き: [↺ -5°] [↻ +5°]                                             |
|  遷移: [前へ] [次へ]   |   [削除]   |   [保存]                       |
+--------------------------------------------------------------------+
```

* **ツールバー**

  * **全体表示**：地図の全域へリセット。
  * **モード切替**：ナビゲーション↔フォーカス。未保存編集があれば警告。
  * **保存**：CSVへ即時反映（上書き）。初回のみバックアップ生成。
  * **設定**：近傍選択 px の変更と、(E,N)↔(x,y) 相似変換の再推定を提供。

### 2.2 ナビゲーションモード

* **パン/ズーム**：matplotlib 標準ナビゲーション（ホイール/ドラッグ）。
* **点選択**：左クリック → 画面座標で最近傍の点（≤ px しきい値）をヒット → **フォーカスモードへ移行**。
* **ハイライト**：マウスホバー中の選択候補にマーキング（点や枠）。フォーカス移行後も強調を維持する。

### 2.3 フォーカスモード

* **自動ズーム**：選択点を中心に**表示短辺を±25 m**に合わせる（長辺は地図の16:9比に依存して自動決定）。地図端では範囲をクランプ。
* **情報表示（RO）**：

  * `label`（数値は整数化、文字列はそのまま）
  * `latitude, longitude`
  * `x, y, yaw(deg)`（yawは q→yaw(ENU, Z回頭, 反時計回り正, 0°は+X）で表示）
* **微調整**：

  * **位置**：8方向ボタン → **0.25 m** 単位で移動
  * **向き**：回転ボタン → **±5°**
* **フラグ編集**：5項目を Entry で編集

  * 入力検証：`*_is_open >= 0` の float、他は `0/1` の int
* **削除**：確認ダイアログ後、該当行を DataFrame から削除 → 自動で「次へ」へ遷移（なければ「前へ」）。
* **保存**：即時 CSV に反映（上書き）。列順・既存の派生列を保持。

---

## 3. データモデル・入出力

### 3.1 CSV 読み込み

* pandas で読込。**列順は保持**。存在しない派生列（`utm_x` 以降）は無視（無くても可）。
* 必須列：

  * 位置・姿勢：`latitude, longitude, x, y, z, q1..q4（= x,y,z,w）`
  * フラグ：`right_is_open, left_is_open, line_is_stop, signal_is_stop, isnot_skipnum`
  * `label`（型は数値/文字どちらも可；表示は要件に従う）
* 四元数列名の検出：`q1..q4` or `qx,qy,qz,qw` のような別名にも対応（**x,y,z,w**の順でマップ）。

### 3.2 CSV 保存

* 初回保存直前に `*_backup_YYYYmmdd-HHMMSS.csv` を自動生成。
* 以降の保存は `<元名>_edited.csv` に **上書き**。
* **列順・行順を維持**。
* 型整形：

  * `*_is_open` は float として保存（整数入力可）。
  * `line_is_stop, signal_is_stop, isnot_skipnum` は 0/1 int。
  * 浮動小数は（既定）最大 7 桁程度に丸めて出力（差分の安定化）。

---

## 4. 座標・姿勢の取り扱い

### 4.1 地図変換

* 描画・選択は**必ず**添付 `latlon_to_pixel_mapper.py` の API を使用。

  * `latlon_to_pixel(lat, lon) -> (px, py)`
  * `pixel_to_latlon(px, py) -> (lat, lon)`
  * （APIにある場合）`latlon_to_local_meters(lat, lon) -> (e, n)` / `local_meters_to_latlon(e, n) -> (lat, lon)` を優先使用。
  * 無い場合でも、同モジュールにあるユーティリティ（PGWのアフィン）で同等のローカルメートル座標を得る（**本ツールで新規関数は作らない。既存APIの呼出しのみ**）。

### 4.2 **x,y 座標と (lat,lon) の関係の自動同定（重要）**

> ENUと一致しない可能性があるため、**CSVの (x,y) と 地図ローカルメートル系 (E,N)** の間の **2次元相似変換**（回転 + ひずみ無しのスケール + 平行移動）を自動推定します。

* **手順**

  1. CSV の **先頭から K 点（既定 K=20、ファイル点数が少なければ全点）**を抽出。
  2. 各点の `(latitude, longitude)` を mapper で **ローカルメートル系 (E,N)** に変換。
  3. 2 組の対応点集合 **P = {(E_i,N_i)}**, **Q = {(x_i,y_i)}** から、**最小二乗の 2D 相似変換** `Q ≈ s·R·P + t` を推定。

     * ロバスト性確保のため **RANSAC 付き Procrustes** を適用（外れ値を除外）。
  4. 推定残差 RMS と一致度（相関）を計算してログ表示。一定閾値を超える場合は「**x,y の系が相似変換で表せない**」旨を警告（ただし編集・保存は継続可能）。
* **利用**

  * **編集時の 0.25 m シフト**は、まず **(E,N)** に対して Δ を適用 → **lat/lon** を更新。
  * 同時に **(x,y)** は **推定した相似変換**で **(E,N)** から算出して更新（`(x,y) = s·R·(E,N) + t`）。
  * これにより、**lat/lon と x,y の整合**が常に保たれます。
* **特記事項**

  * 変換の不確かさは編集パネル下に数値表示（RMS [m]）。
  * 再推定ボタンを用意（設定内）。
  * K 点は設定で変更可（実装では既定値20で固定）。

### 4.3 位置シフト（0.25 m）

* フォーカスモードの 8 方向ボタンは、**地図ローカルメートル系 (E,N)** の **直交方向**として定義。

  * 上：ΔN=+0.25, 下：ΔN=-0.25, 右：ΔE=+0.25, 左：ΔE=-0.25, 対角はそれぞれ ±0.25 を合成。
* 反映する列：

  * **lat/lon**：`(E,N)+=Δ` → mapper で逆変換して更新
  * **x,y**：`(x,y) = s·R·(E,N) + t` 後の値を保存
  * **z**：変更なし（RO 表示）

### 4.4 向き回転（±5°）

* yaw は **ENU 平面の Z 軸回頭**。**反時計回りが正**、**0°は +X（E）方向**。
* 回転後：`yaw = norm_angle(yaw ± 5°)`（-180..180 or 0..360、内部はラジアン）。
* 四元数：**geometry_msgs/Pose** 準拠（`x,y,z,w`）で、Z 回頭の q を算出し直して **規格化**後に保存。

---

## 5. 可視化（強調表示・優先順位）

* **点色/枠**の優先順位（ご指定どおり）：

  1. `signal_is_stop == 1`（最優先、赤枠）
  2. `line_is_stop == 1`（黄枠）
  3. `*_is_open > 0`（右=緑・左=紫、点サイズ↑ or 塗り分け）
  4. `isnot_skipnum == 1`（青点線枠 など）
* 複合時は **最上位の枠**を採用しつつ、`*_is_open` の情報は **点サイズ/色相**で補助的に表現（情報過多を避けるバランス）。
* **ラベル表示**は高倍率時のみ（重なり抑制）。

---

## 6. 近傍選択

* 既定しきい値：**10 px**（設定で変更可）。
* 算出：クリック位置と各点のスクリーン座標（pixel）で距離最小を選択。
* 該当なし（最小距離 > しきい値）は無視。

---

## 7. 削除・保存・安全策

* **削除**：確認ダイアログ → DataFrame から行削除 → 直後は「次へ」に自動遷移。
* **未保存変更**：モード切替・全体表示・アプリ終了時に警告。
* **保存**：

  * 初回のみバックアップ。
  * 列順・行順・未編集列（派生列）の値は**原則維持**。
  * 保存後は「変更件数」と「対象 label 一覧」をミニログで表示。
* **入力検証**：

  * `*_is_open`：空/負数/文字 → エラー
  * 0/1 系：0/1 以外 → エラー
  * エラー時は保存不可（エラーフィールドを赤枠表示）。

---

## 8. パフォーマンスと実装方針

* 全点再描画を避け、**差分更新 + `draw_idle()`** を基本に高速化。
* `quiver` はズーム倍率に応じ矢印長を動的調整（常に視認性確保）。
* 実装は **Tkinter + matplotlib + pandas**。
* 地図座標変換は **`latlon_to_pixel_mapper.py` の API のみ使用**（新規の座標関数を自作しない）。
* 主要クラス分割（目安）：

  * `MapAdapter`：mapper API 呼び出しラッパ（latlon↔pixel, latlon↔local(m)）
  * `XYAligner`：2D 相似変換の推定・適用（(E,N) ↔ (x,y)）
  * `WaypointStore`：DataFrame 管理（読込・検証・保存）
  * `Viewer`：描画・ヒットテスト
  * `Editor`：フォーカスモード操作（シフト・回転・フラグ・削除）
  * `App`：Tkinter ルート、モード切替、設定・保存など

---

## 9. ログ・トレース・テスト

* **ログ**：選択→編集→保存までを時刻付きで標準出力（オプションで UI 側にもテキスト表示）。
* **テスト（抜粋）**

  1. CSV 読込：必須列の有無、q 列名バリエーションの検出、label の表示（数値/文字）
  2. 近傍選択：密集領域で意図通りに選べる（しきい値変更の効果）
  3. 相似変換推定：RANSAC で外れ値が除かれる、RMS が許容範囲（例：≦ 0.2 m）
  4. 0.25 m シフト連打：lat/lon と x,y が一貫して変化、保存→再読込で再現
  5. ±5° 回転連打：q の正規化、yaw 表示の連続性
  6. フラグ検証：境界値入力、複合表示の優先順位
  7. 削除：遷移・保存・再読込の整合
  8. 16:9 マップ・短辺±25 m 自動ズームの外縁クランプ

---

## 10. 例外時のふるまい

* **相似変換の推定失敗/高残差**：

  * 警告表示（推定 RMS を明示）。
  * それでも編集は続行可能（x,y が ENU と強く乖離する恐れあり、という注意を継続表示）。
  * 必要なら「x,y 更新を一時停止（lat/lon のみ更新）」オプションを設定に用意。
* **map/pgw 不整合**：mapper 例外を捕捉し、起動時にエラーダイアログで中断。
* **保存不可**：ファイル権限やパス異常はエラーダイアログ。

---

### 付録A：主要アルゴリズム（概要）

* **2D 相似変換（Procrustes + RANSAC）**

  * 変換：`Q ≈ s·R·P + t`
  * `R` は回転行列、`s` は等方スケール、`t` は平行移動。
  * RANSAC で外れ値を除外しつつ最小二乗で s,R,t を推定。
  * 推定後、`(x,y)` の更新や逆変換は線形部を利用。

* **yaw ↔ quaternion**（Z回頭のみ）

  * `qx=qy=0`、`qz = sin(yaw/2)`, `qw = cos(yaw/2)` を既定とし、CSVと整合する並び（x,y,z,w）で保存。
  * 既存 q を上書き（規格化）。

---

